<template>
  <div class="main">
    <ModalVue v-show="isModalVisible" v-on:close="closeModal">
      <template v-slot:header>
        {{ headerText }}
      </template>

      <template v-slot:body>
        <p>{{ bodyText }}</p>
        <p>{{ gameDate }}</p>
        <p>{{ gameLoc }}</p>
        <p>{{ seeYa }}</p>
      </template>

      <template v-slot:footer> </template>
    </ModalVue>
    <div class="form center">
      <div class="header center">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–ê&nbsp–ò–ì–†–£</div>

      <div class="game_num center">6-—è –∏–≥—Ä–∞ –ë–∞—É–º–∞–Ω—Å–∫–æ–π –ª–∏–≥–∏</div>

      <div class="info center">
        <div class="info_clock"><img src="../assets/images/clock.svg" /></div>
        <div class="info_text">21 —Ñ–µ–≤—Ä–∞–ª—è, –°–† 19:00</div>
      </div>

      <div class="info center">
        <div class="info_loc"><img src="../assets/images/location.svg" /></div>
        <div class="info_text">345 –∞—É–¥–∏—Ç–æ—Ä–∏—è (–ì–£–ö –ú–ì–¢–£ –∏–º. –ù.–≠. –ë–∞—É–º–∞–Ω–∞)</div>
      </div>
      <div class="info center">
        <div class="info_warn"><img src="../assets/images/warning.svg" /></div>
        <div class="info_text">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–ø–∏—Ç–∞–Ω –∫–æ–º–∞–Ω–¥—ã</div>
      </div>

      <form class="btn_container center">
        <div class="block_input center">
          <div class="block_text">–ò–ú–Ø –ö–ê–ü–ò–¢–ê–ù–ê <span class="star">*</span></div>
          <input
            v-model="form.captain_name"
            :class="{ error: formFormatters.captainNameIsEmpty }"
            required
            class="input"
            type="text"
            placeholder="–ù–∏–∫–æ–ª–∞–π –≠—Ä–Ω–µ—Å—Ç–æ–≤–∏—á –ë–∞—É–º–∞–Ω"
          />
        </div>
        <div class="block_input center">
          <div class="block_text">
            –£–ß–ï–ë–ù–ê–Ø –ì–†–£–ü–ü–ê –ö–ê–ü–ò–¢–ê–ù–ê <span class="star">*</span>
          </div>
          <input
            v-model="form.group_name"
            :class="{ error: formFormatters.groupNameIsEmpty }"
            required
            class="input"
            type="text"
            placeholder="–°–ú1-11"
          />
        </div>

        <div class="block_input center">
          <div class="block_text">
            –ù–û–ú–ï–† –¢–ï–õ–ï–§–û–ù–ê <span class="star">*</span>
          </div>
          <input
            v-model="form.phone"
            :class="{ error: formFormatters.phoneIsEmpty }"
            required
            class="input"
            type="text"
            placeholder="8(999)888-77-66"
          />
        </div>
        <div class="block_input center">
          <div class="block_text">TELEGRAM <span class="star">*</span></div>
          <input
            v-model="form.tg_contact"
            :class="{ error: formFormatters.tgContactIsEmpty }"
            required
            class="input"
            type="text"
            placeholder="@quizonmsk"
          />
        </div>
        <div class="block_input center">
          <div class="block_text">
            –ù–ê–ó–í–ê–ù–ò–ï –ö–û–ú–ê–ù–î–´ <span class="star">*</span>
          </div>
          <input
            v-model="form.team_name"
            :class="{ error: formFormatters.teamNameIsEmpty }"
            required
            class="input"
            type="text"
            placeholder="–ö–≤–∏–∑ON"
          />
        </div>
        <div class="block_input center">
          <div class="block_text">
            –ö–û–õ–ò–ß–ï–°–¢–í–û –ß–ï–õ–û–í–ï–ö <span class="star">*</span>
          </div>
          <input
            v-model="form.amount"
            :class="{ error: formFormatters.teamSizeIsEmpty }"
            required
            class="input"
            type="text"
            placeholder="6"
          />
        </div>
        <div class="block_input center">
          <div class="block_text">ID –ö–û–ú–ê–ù–î–´</div>
          <input
            v-model="form.team_id"
            required
            class="input"
            type="text"
            placeholder="0002"
          />
        </div>
        <button type="button" class="reg_btn" v-on:click="buttonClicked">
          –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </button>
        <div class="agreement">
          –û—Ç–ø—Ä–∞–≤–ª—è—è —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å –Ω–∞&nbsp<a
            href="https://bmstu.ru/about/obrabotka-dannyh"
            class="agreement_link"
            >–æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a
          >
        </div>
      </form>
    </div>
  </div>
</template>

<script>
import ModalVue from '../components/ModalVue.vue'

export default {
  name: 'registration',
  components: { ModalVue },
  data() {
    return {
      canRegister: '',
      headerText: '',
      bodyText: '',
      gameDate: '',
      gameLoc: '',
      seeYa: '',
      isModalVisible: false,
      formFormatters: {
        captainNameIsEmpty: false,
        groupNameIsEmpty: false,
        phoneIsEmpty: false,
        teamNameIsEmpty: false,
        teamSizeIsEmpty: false,
        tgContactIsEmpty: false,
      },
      form: {
        tg_contact: '',
        team_id: '',
        captain_name: '',
        group_name: '',
        phone: '',
        team_name: '',
        amount: null,
      },
    }
  },
  beforeMount() {
    this.canRegister = this.checkIfCanRegister()
  },

  methods: {
    showModal() {
      this.isModalVisible = true
    },
    closeModal() {
      this.isModalVisible = false
    },
    async checkIfCanRegister() {
      try {
        const response = await fetch(
          'https://www.quiz-on.ru/api/register-available'
        )
        const resp = await response.json()
        const available = resp.available
        if (available === 'reserve') {
          this.headerText = '–£–ø—Å... üëâüèªüëàüèª'
          this.bodyText =
            '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º–µ—Å—Ç–∞ –Ω–∞\u00A0–∏–≥—Ä—É –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å. –ù–æ –Ω–µ —Å—Ç–æ–∏—Ç –æ–ø—É—Å–∫–∞—Ç—å —Ä—É–∫–∏ —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏! –ú—ã –º–æ–∂–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–≤–æ—é –∫–æ–º–∞–Ω–¥—É –≤\u00A0—Ä–µ–∑–µ—Ä–≤, —á—Ç–æ–±—ã –≤\u00A0—Å–ª—É—á–∞–µ –æ—Ç–∫–∞–∑–∞  –æ—Ç\u00A0–∫–∞–∫–æ–π-—Ç–æ –∏–∑ –ø—Ä–æ—à–µ–¥—à–∏—Ö –∫–æ–º–∞–Ω–¥, –≤—ã –º–æ–≥–ª–∏ –∑–∞–Ω—è—Ç—å –∏—Ö –º–µ—Å—Ç–æ. –•–æ—á–µ—à—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤\u00A0—Ä–µ–∑–µ—Ä–≤?'
          this.showModal()
        }
        return available
      } catch (error) {
        this.headerText = '–û—à–∏–±–∫–∞!'
        this.bodyText = '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫'
        this.showModal()
      }
    },

    buttonClicked() {
      if (this.form.captain_name === '') {
        this.formFormatters.captainNameIsEmpty = true
      } else {
        this.formFormatters.captainNameIsEmpty = false
      }
      if (this.form.group_name === '') {
        this.formFormatters.groupNameIsEmpty = true
      } else {
        this.formFormatters.groupNameIsEmpty = false
      }
      if (this.form.phone === '') {
        this.formFormatters.phoneIsEmpty = true
      } else {
        this.formFormatters.phoneIsEmpty = false
      }
      if (this.form.team_name === '') {
        this.formFormatters.teamNameIsEmpty = true
      } else {
        this.formFormatters.teamNameIsEmpty = false
      }
      if (this.form.tg_contact === '') {
        this.formFormatters.tgContactIsEmpty = true
      } else {
        this.formFormatters.tgContactIsEmpty = false
      }
      if (this.form.amount == null || this.form.amount <= 1) {
        this.formFormatters.teamSizeIsEmpty = true
      } else {
        this.formFormatters.teamSizeIsEmpty = false
      }

      if (
        this.formFormatters.captainNameIsEmpty === false &&
        this.formFormatters.groupNameIsEmpty === false &&
        this.formFormatters.phoneIsEmpty === false &&
        this.formFormatters.teamNameIsEmpty === false &&
        this.formFormatters.teamSizeIsEmpty === false &&
        this.formFormatters.tgContactIsEmpty === false
      ) {
        this.postData('https://www.quiz-on.ru/api/register', this.form).then(
          (response) => {
            if (response.status !== 200) {
              this.headerText = '–û–π üôà!'
              this.bodyText = '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫'
              this.showModal()
            } else {
              if (this.canRegister == 'reserve') {
                this.headerText =
                  'ü§ì –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –ø–µ—Ä–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –æ—Ç –ö–≤–∏–∑ON —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî —Ç–≤–æ—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!'
                this.bodyText =
                  '–°–∫–æ—Ä–æ —Å —Ç–æ–±–æ–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–≤—è–∂—É—Ç—Å—è, –∞ –µ—Å–ª–∏ –º–µ—Å—Ç–∞ –æ—Å–≤–æ–±–æ–¥—è—Ç—Å—è ‚Äì —Å–æ–æ–±—â–∞—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–∞—Ç –º–µ—Å—Ç–æ –Ω–∞ –∏–≥—Ä–µ –≤ –ø–æ—Ä—è–¥–∫–µ –æ—á–µ—Ä–µ–¥–∏.'
                this.gameDate = ''
                this.seeYa = ''
              } else {
                this.headerText =
                  '‚òÉÔ∏è –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –ø–µ—Ä–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è –æ—Ç\u00A0–ö–≤–∏–∑ON —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã ‚Äî —Ç–≤–æ—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞!'

                this.bodyText =
                  '–ü–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –Ω–∞\u00A0—à–µ—Å—Ç–æ–π –∏–≥—Ä–µ –ë–∞—É–º–∞–Ω—Å–∫–æ–π –ª–∏–≥–∏ –ö–≤–∏–∑ON. –ù–∞–ø–æ–º–Ω–∏–º, —á—Ç–æ –∏–≥—Ä–∞ –ø—Ä–æ–π–¥–µ—Ç:'
                this.gameDate = '‚ö°Ô∏è21 —Ñ–µ–≤—Ä–∞–ª—è, 19:00'
                this.seeYa = '–î–æ –≤—Å—Ç—Ä–µ—á–∏ –Ω–∞ –∏–≥—Ä–µ!'
              }
              this.showModal()
              this.form = {
                tg_contact: '',
                team_id: '',
                captain_name: '',
                group_name: '',
                phone: '',
                team_name: '',
                amount: null,
              }
            }
          }
        )
      } else {
        this.headerText = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞... ü•≤'
        this.bodyText = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã'
        this.showModal()
      }
    },
    async postData(url, data) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
          },
          redirect: 'follow',
          referrerPolicy: 'no-referrer',
          body: JSON.stringify(data),
        })

        return response
      } catch (error) {
        this.headerText = '–û—à–∏–±–∫–∞!'
        this.bodyText = '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫'
        this.showModal()
      }
    },
  },
}
</script>

<style scoped>
.star {
  color: #f4da6a;
}
.main {
  width: 100vw;
  max-width: 450px;
  padding-top: 2vh;
  padding-bottom: 2vh;
}
.form {
  width: 90vw;
  max-width: 405px;
  background-color: #1f354b;
  border-radius: 21px;
  box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.383);
}

.center {
  margin: 0 auto;
}

.header {
  padding-top: 17px;
  box-sizing: border-box;
  font-size: 24px;
  font-family: ProductSans;
  font-weight: 700;
  color: white;
  width: 80vw;
  max-width: 360px;
}

.game_num {
  padding-top: 17px;
  box-sizing: border-box;
  font-size: 21px;
  font-family: ProductSans;
  font-weight: 700;
  color: #f4da6a;
  width: fit-content;
  width: 80vw;
  max-width: 360px;
}

.block_input {
  margin-top: 11px;
  width: 80vw;
  max-width: 360px;
  height: 51px;
}
.reg_btn {
  margin-top: 20px;
  background-color: #182a3e;
  border: 1.33428px solid #f4da6a;
  border-radius: 17.3457px;
  width: 80vw;
  max-width: 360px;
  height: 35px;
  font-family: ProductSans;
  font-weight: 700;
  font-size: 17px;
  color: #ffffff;
  cursor: pointer;
}

.btn_container {
  width: 80vw;
  max-width: 360px;
  font-size: 12px;
  padding-bottom: 30px;
}

.error_output {
  margin-top: 12px;
  width: 80vw;
  max-width: 360px;
  font-family: ProductSans;
  font-weight: 400;
  overflow-wrap: break-word;
  color: #9f2128;
}

.block_text {
  font-size: 13px;
  line-height: 15px;
  font-family: ProductSans;
  font-weight: 700;
  color: #ffffff;
}

::placeholder {
  font-family: ProductSans;
  font-weight: 400;
  font-size: 12px;
  color: #ffffff33;
}

.input {
  padding: 8px;
  margin-top: 6px;
  box-sizing: border-box;
  width: 100%;
  max-width: 360px;
  height: 32px;
  border-radius: 12px;
  border-width: 2px;
  background-color: #182a3e;
  border-color: #ffffff33;
  color: #ffffff;
}

.info {
  display: flex;
  margin-top: 11px;
  width: 80vw;
  max-width: 360px;
}

.info_clock {
  max-width: 5vw;
  /* max-height: 18px; */
}

.info_loc {
  max-width: 16px;
  max-height: 21px;
}

.info_text {
  color: white;
  font-family: ProductSans;
  font-weight: 400;
  font-size: 12px;
  margin-left: 8px;
  margin-top: auto;
  margin-bottom: auto;
}

.agreement {
  margin-top: 20px;
  font-family: ProductSans;
  font-weight: 400;
  font-size: 15px;
  color: white;
}

a {
  color: #f4da6a;
  text-decoration: none;
}

.error {
  border-color: #9f2128;
}
.errorBox {
  box-shadow: 0 0 0 2px #9f2128;
}
</style>
